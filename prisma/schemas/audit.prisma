// prisma/schemas/audit.prisma
// ===== PRODUCTION-READY AUDIT SYSTEM WITH USER SNAPSHOTS =====

model AuditLog {
  id             String        @id @default(cuid())
  organizationId String?       // ✅ FIXED: Made optional for user-level actions
  
  // ✅ Actor (ผู้ทำ) - Snapshot + Optional Relation
  userId         String?       // User ID (for relation/query)
  userSnapshot   Json?         // ✅ User info ณ ขณะนั้น
  
  // ✅ Target (ผู้ถูกกระทำ) - Snapshot + Optional Relation
  targetUserId   String?       // Target User ID
  targetSnapshot Json?         // ✅ Target user info ณ ขณะนั้น
  
  // Department Context
  departmentId   String?
  
  // Action Classification
  action         String        // "products.create", "user.profile_updated"
  category       AuditCategory // PRODUCT, STOCK, TRANSFER, USER, ORG
  severity       AuditSeverity @default(INFO)
  
  // Human-Readable Description
  description    String        // "สมชาย สร้างสินค้า Paracetamol ที่คลังยา"
  
  // Resource Tracking
  resourceId     String?       // ID ของ record
  resourceType   String?       // "Product", "Stock", "Transfer", "User"
  
  // Detailed Data (before/after comparison)
  payload        Json?         // { before, after, metadata }
  
  // Request Context
  ipAddress      String?
  userAgent      String?
  
  // Timestamp
  createdAt      DateTime @default(now())
  
  // ✅ Relations (ยังคงไว้สำหรับ query/join) - Made optional
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User? @relation("AuditLogUser", fields: [userId], references: [id], onDelete: SetNull)
  targetUser     User? @relation("AuditLogTarget", fields: [targetUserId], references: [id], onDelete: SetNull)
  department     Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  // Optimized Indexes
  @@index([organizationId, createdAt(sort: Desc)])
  @@index([departmentId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([action])
  @@index([category, severity])
  @@index([resourceId])
  @@map("audit_logs")
}

// Enums (ไม่เปลี่ยนแปลง)
enum AuditCategory {
  PRODUCT       // สินค้า
  STOCK         // สต็อก
  TRANSFER      // การโอนย้าย
  USER          // ผู้ใช้
  ORGANIZATION  // องค์กร
  DEPARTMENT    // หน่วยงาน
  AUTH          // Authentication
  SYSTEM        // ระบบ
}

enum AuditSeverity {
  INFO          // ปกติ (90%)
  WARNING       // สำคัญ (8%)
  CRITICAL      // วิกฤติ (2%)
}