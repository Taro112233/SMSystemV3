// prisma/schemas/organization.prisma
// ===== ORGANIZATION SCHEMA WITH USER SNAPSHOTS =====

model Organization {
  id          String             @id @default(cuid())
  name        String
  slug        String             @unique
  description String?
  
  // Contact Information
  email       String?
  phone       String?
  
  // Visual Customization
  color       ColorTheme?        @default(BLUE)
  icon        IconType?          @default(BUILDING)
  
  // Settings
  status      OrganizationStatus @default(ACTIVE)
  timezone    String             @default("Asia/Bangkok")
  
  // Invite Code System
  inviteCode     String?    @unique
  inviteEnabled  Boolean    @default(true)
  
  // Timestamps
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  
  // Relations
  users       OrganizationUser[]
  departments Department[]
  auditLogs   AuditLog[]
  
  @@index([slug])
  @@index([status])
  @@index([inviteCode])
  @@map("organizations")
}

// User-Organization Relationship
model OrganizationUser {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  
  // Role & Membership
  roles          OrganizationRole @default(MEMBER)
  isOwner        Boolean      @default(false)
  joinedAt       DateTime     @default(now())
  lastActiveAt   DateTime?
  
  // Status
  isActive       Boolean      @default(true)
  
  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([organizationId, userId])
  @@index([isActive])
  @@index([roles])
  @@map("organization_users")
}

// ✅ UPDATED: Department with User Snapshots
model Department {
  id             String       @id @default(cuid())
  organizationId String
  parentId       String?
  
  // Department Details
  name           String
  slug           String
  description    String?
  color          ColorTheme?
  icon           IconType?
  
  // Status
  isActive       Boolean      @default(true)
  
  // ✅ NEW: Created By - Snapshot + Relation
  createdBy      String       // User ID
  createdBySnapshot Json?     // ✅ NEW: Creator info ณ ขณะนั้น
  // Example: { userId, username, fullName, email, role }
  
  // ✅ NEW: Updated By - Snapshot + Relation
  updatedBy      String?      // Last updater ID
  updatedBySnapshot Json?     // ✅ NEW: Last updater info ณ ขณะนั้น
  
  // Timestamps
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent         Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children       Department[] @relation("DepartmentHierarchy")
  auditLogs      AuditLog[]
  
  @@unique([organizationId, slug])
  @@index([parentId])
  @@index([isActive])
  @@map("departments")
}