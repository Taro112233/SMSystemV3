// prisma/schemas/organization.prisma
// ===== AUTHENTICATION ORGANIZATION SCHEMA - InvenStock V2.0 =====

model Organization {
  id          String             @id @default(cuid())
  name        String
  slug        String             @unique // URL-friendly identifier
  description String?
  
  // Contact Information
  email       String?
  phone       String?
  
  // Settings
  status      OrganizationStatus @default(ACTIVE)
  timezone    String             @default("Asia/Bangkok")
  
  // Feature Settings
  allowDepartments    Boolean    @default(true)
  
  // Timestamps
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  
  // Relations (Authentication Only)
  users       OrganizationUser[]
  departments Department[]       // Keep for department access control
  invitations UserInvitation[]
  auditLogs   AuditLog[]
  
  @@index([slug])
  @@index([status])
  @@map("organizations")
}

// User-Organization Relationship (Many-to-Many)
model OrganizationUser {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  
  // Role & Membership
  roles          OrganizationRole @default(MEMBER)
  isOwner        Boolean      @default(false)
  joinedAt       DateTime     @default(now())
  lastActiveAt   DateTime?
  
  // Status
  isActive       Boolean      @default(true)
  
  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([organizationId, userId])
  @@index([isActive])
  @@index([roles])
  @@map("organization_users")
}

// Hierarchical Departments (For Access Control)
model Department {
  id             String       @id @default(cuid())
  organizationId String
  parentId       String?      // For hierarchical structure
  
  // Department Details
  name           String
  code           String       // Short code (e.g., "ICU", "OPD", "PHARMACY")
  description    String?
  color          ColorTheme?
  icon           IconType?
  
  // Access Control
  isActive       Boolean      @default(true)
  requiresAccess Boolean      @default(false)  // Requires explicit access permission
  
  // Audit Fields
  createdBy      String       // User who created
  updatedBy      String?      // User who last updated
  
  // Timestamps
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent         Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children       Department[] @relation("DepartmentHierarchy")
  departmentUsers DepartmentUser[]  // Users with access to this department
  
  @@unique([organizationId, code])
  @@index([parentId])
  @@index([isActive])
  @@index([requiresAccess])
  @@map("departments")
}